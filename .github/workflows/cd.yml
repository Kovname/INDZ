name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš‚ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸš€ Deploy to Railway (Staging)
        run: |
          railway up --service web --environment staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: ğŸ” Run smoke tests
        run: |
          sleep 30
          curl -f https://web-production-2725.up.railway.app/health || exit 1
          curl -f https://web-production-2725.up.railway.app/ || exit 1
        continue-on-error: true

  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: ${{ github.event.inputs.environment == 'production' }}
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš‚ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸ­ Deploy to Railway (Production)
        run: |
          railway up --service web --environment production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  notify-slack:
    name: ğŸ“¢ Slack Notification
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always()

    steps:
      - name: ğŸ“¢ Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#ci-cd-notifications"
          fields: repo,message,commit,author,action,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
